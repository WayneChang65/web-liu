const mainEditor=document.getElementById("main-editor"),imeBar=document.getElementById("ime-bar"),inputBufferSpan=document.getElementById("input-buffer"),candidateListSpan=document.getElementById("candidate-list"),modeIndicator=document.getElementById("mode-indicator"),copyButton=document.getElementById("copy-button"),themeToggleButton=document.getElementById("theme-toggle-button"),immersiveToggleButton=document.getElementById("immersive-toggle-button"),zoomInButton=document.getElementById("zoom-in-button"),zoomOutButton=document.getElementById("zoom-out-button"),saveMdButton=document.getElementById("save-md-button");let inputBuffer="",candidates=[],currentPage=0;const pageSize=10;let imeMode="boshiamy",currentFontSize=1.2;const turndownService=new TurndownService;function toggleStyle(e){const t=window.getSelection();if(!t.rangeCount)return;const n=t.getRangeAt(0);if(!n.toString())return;const o=1===n.commonAncestorContainer.nodeType?n.commonAncestorContainer:n.commonAncestorContainer.parentElement,a={bold:"STRONG",italic:"EM",underline:"U"}[e],i=o.closest(a);if(i){const e=document.createTextNode(i.textContent);i.parentNode.replaceChild(e,i),n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}else{const e=document.createElement(a);try{n.surroundContents(e)}catch(t){const o=n.extractContents();e.appendChild(o),n.insertNode(e)}}}function applyTheme(e){"dark"===e?(document.body.classList.add("dark-mode"),themeToggleButton.textContent="切換淺色模式"):(document.body.classList.remove("dark-mode"),themeToggleButton.textContent="切換深色模式")}themeToggleButton.addEventListener("click",(()=>{const e=document.body.classList.toggle("dark-mode")?"dark":"light";localStorage.setItem("theme",e),applyTheme(e)}));const savedTheme=localStorage.getItem("theme")||"light";function updateFontSize(){mainEditor.style.fontSize=`${currentFontSize}rem`,updateModeIndicator()}function toggleImeMode(){imeMode="boshiamy"===imeMode?"english":"boshiamy",clearImeState(),updateModeIndicator()}function updateModeIndicator(){const e="boshiamy"===imeMode?"嘸蝦米模式":"英數模式",t="boshiamy"===imeMode?"boshiamy":"english",n=Math.round(10*currentFontSize);modeIndicator.innerHTML=`目前為：<span class="mode-text ${t}">${e}</span> (Ctrl+p 切換), 字型大小：${n}`}function handleKeyDown(e){const t=e.key;if(e.ctrlKey||e.metaKey){if(["b","i","u"].includes(t.toLowerCase())){e.preventDefault();return void toggleStyle({b:"bold",i:"italic",u:"underline"}[t.toLowerCase()])}return"p"===t.toLowerCase()?(e.preventDefault(),void toggleImeMode()):void 0}if("boshiamy"===imeMode){if(/^[a-z,.'\[\]v]$/.test(t)){e.preventDefault(),inputBuffer+=t;const n=boshiamyData[inputBuffer];candidates=n?n.split(""):[],currentPage=0,updateImeDisplay()}else if(t>="0"&&t<="9"&&candidates.length>0){e.preventDefault();const n=parseInt(t,10),o=10*currentPage+n;o<candidates.length&&commitText(candidates[o])}else if("Backspace"===t)if(e.preventDefault(),inputBuffer.length>0){inputBuffer=inputBuffer.slice(0,-1);const e=boshiamyData[inputBuffer];candidates=e?e.split(""):[],currentPage=0,updateImeDisplay()}else{const e=window.getSelection();if(!e.rangeCount)return;const t=e.getRangeAt(0);t.collapsed&&t.setStart(t.startContainer,Math.max(0,t.startOffset-1)),t.deleteContents()}else if(" "===t||"Spacebar"===t){if(0===inputBuffer.length)return;if(e.preventDefault(),inputBuffer.length>1&&inputBuffer.endsWith("v")){const e=inputBuffer.slice(0,-1),t=boshiamyData.hasOwnProperty(e)&&boshiamyData[e].length>1,n=boshiamyData.hasOwnProperty(inputBuffer);if(t&&!n){return void commitText(boshiamyData[e].split("")[1])}}if(candidates.length>0){const e=Math.ceil(candidates.length/10);e>1?(currentPage=(currentPage+1)%e,updateImeDisplay()):commitText(candidates[0])}}else if("Enter"===t)if(inputBuffer.length>0&&candidates.length>0)e.preventDefault(),commitText(candidates[0]);else{e.preventDefault();const t=window.getSelection();if(!t.rangeCount)return;const n=t.getRangeAt(0);n.deleteContents();const o=document.createElement("br");n.insertNode(o);const a=document.createTextNode("​");n.setStartAfter(o),n.insertNode(a),n.setStart(a,0),n.collapse(!0),t.removeAllRanges(),t.addRange(n),requestAnimationFrame((()=>{const e=window.getSelection();if(!e.rangeCount)return;const t=e.getRangeAt(0),n=document.createElement("span");t.insertNode(n);const o=n.getBoundingClientRect();n.parentNode.removeChild(n);const a=mainEditor.getBoundingClientRect(),i=window.getComputedStyle(mainEditor),d=parseFloat(i.paddingBottom),r=a.bottom-d;o.bottom>r&&(mainEditor.scrollTop+=o.bottom-r)}))}else t.startsWith("Arrow")&&clearImeState()}}function updateImeDisplay(){if(0!==inputBuffer.length)if(inputBufferSpan.textContent=inputBuffer,candidates.length>0){const e=10*currentPage,t=e+10,n=candidates.slice(e,t);let o="";if(n.forEach(((e,t)=>{o+=`${t}. ${e} `})),candidates.length>10){const e=Math.ceil(candidates.length/10);o+=`(${currentPage+1}/${e})`}candidateListSpan.textContent=o.trim(),imeBar.style.display="flex"}else candidates=[],candidateListSpan.textContent="（無對應字）",imeBar.style.display="flex";else imeBar.style.display="none"}function commitText(e){const t=window.getSelection();if(!t.rangeCount)return;const n=t.getRangeAt(0);n.deleteContents();const o=document.createTextNode(e);n.insertNode(o),n.setStartAfter(o),n.collapse(!0),t.removeAllRanges(),t.addRange(n),clearImeState(),mainEditor.focus()}function clearImeState(){inputBuffer="",candidates=[],currentPage=0,imeBar.style.display="none"}applyTheme(savedTheme),immersiveToggleButton.addEventListener("click",(()=>{const e=document.body.classList.toggle("immersive-mode");immersiveToggleButton.textContent=e?"離開沉浸模式":"沉浸模式"})),zoomInButton.addEventListener("click",(()=>{currentFontSize+=.1,updateFontSize()})),zoomOutButton.addEventListener("click",(()=>{currentFontSize>.5&&(currentFontSize-=.1,updateFontSize())})),modeIndicator.addEventListener("click",toggleImeMode),mainEditor.addEventListener("keydown",handleKeyDown),mainEditor.focus(),updateModeIndicator(),updateFontSize(),mainEditor.addEventListener("blur",(()=>{clearImeState()})),copyButton.addEventListener("click",(()=>{const e=mainEditor.innerText;e&&navigator.clipboard.writeText(e).then((()=>{const e=copyButton.textContent;copyButton.textContent="已複製！",setTimeout((()=>{copyButton.textContent=e}),2e3)})).catch((e=>{}))})),mainEditor.addEventListener("paste",(e=>{e.preventDefault();const t=(e.clipboardData||window.clipboardData).getData("text/plain"),n=window.getSelection();if(!n.rangeCount)return;const o=n.getRangeAt(0);o.deleteContents();const a=document.createTextNode(t);o.insertNode(a),o.setStartAfter(a),o.collapse(!0),n.removeAllRanges(),n.addRange(o),requestAnimationFrame((()=>{const e=window.getSelection();if(!e.rangeCount)return;const t=e.getRangeAt(0),n=document.createElement("span");t.insertNode(n);const o=n.getBoundingClientRect();n.parentNode.removeChild(n);const a=mainEditor.getBoundingClientRect(),i=window.getComputedStyle(mainEditor),d=parseFloat(i.paddingBottom),r=a.bottom-d;o.bottom>r&&(mainEditor.scrollTop+=o.bottom-r)}))})),saveMdButton.addEventListener("click",(()=>{const e=mainEditor.innerHTML;if(e){const t=turndownService.turndown(e),n=new Blob([t],{type:"text/markdown;charset=utf-t"}),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download="document.md",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(o.href)}}));