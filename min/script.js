const mainEditor=document.getElementById("main-editor"),imeBar=document.getElementById("ime-bar"),inputBufferSpan=document.getElementById("input-buffer"),candidateListSpan=document.getElementById("candidate-list"),modeIndicator=document.getElementById("mode-indicator"),copyButton=document.getElementById("copy-button"),themeToggleButton=document.getElementById("theme-toggle-button"),immersiveToggleButton=document.getElementById("immersive-toggle-button"),zoomInButton=document.getElementById("zoom-in-button"),zoomOutButton=document.getElementById("zoom-out-button"),saveMdButton=document.getElementById("save-md-button"),restoreButton=document.getElementById("restore-button"),buttonContainer=document.querySelector(".button-container"),buttonToggle=document.getElementById("button-toggle"),editorTabs=document.getElementById("editor-tabs"),topButtonContainer=document.getElementById("top-button-container"),topButtonToggle=document.getElementById("top-button-toggle"),logoContainer=document.getElementById("logo-container"),logoImage=logoContainer.querySelector("img");let currentEditorId=1,editorContents={1:"",2:"",3:""},inputBuffer="",candidates=[],currentPage=0;const pageSize=10;let imeMode=localStorage.getItem("boshiamy-ime-mode")||"boshiamy",lastActiveImeMode="boshiamy";lastActiveImeMode="disabled"===imeMode?"boshiamy":imeMode;let inactivityTimer,currentFontSize=parseFloat(localStorage.getItem("boshiamy-font-size"))||1.2,zoomInterval=null,persistentSaveListenersAttached=!1;function attachPersistentSaveListeners(){persistentSaveListenersAttached||(document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&autoSaveChanges()}),persistentSaveListenersAttached=!0)}function debounce(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout(()=>e.apply(this,o),t)}}const turndownService=new TurndownService({headingStyle:"atx"});function toggleStyle(e){const t=window.getSelection();if(!t.rangeCount)return;const n=t.getRangeAt(0);if(!n.toString())return;const o=1===n.commonAncestorContainer.nodeType?n.commonAncestorContainer:n.commonAncestorContainer.parentElement,i={bold:"STRONG",italic:"EM",underline:"U"}[e],a=o.closest(i);if(a){const e=document.createTextNode(a.textContent);a.parentNode.replaceChild(e,a),n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}else{const e=document.createElement(i);try{n.surroundContents(e)}catch(t){console.warn("surroundContents failed, falling back.",t);const o=n.extractContents();e.appendChild(o),n.insertNode(e)}t.removeAllRanges();const o=document.createRange();o.selectNodeContents(e),t.addRange(o)}}function changeSelectionFontSize(e){const t=window.getSelection();if(!t.rangeCount||t.isCollapsed)return;const n=t.getRangeAt(0),o=n.commonAncestorContainer,i=(o.nodeType===Node.ELEMENT_NODE?o:o.parentElement).closest('span[data-font-sized="true"]');if(i){const o=parseFloat(window.getComputedStyle(i).fontSize),a="increase"===e?o+1:o-1;a>0&&(i.style.fontSize=`${a}px`),t.removeAllRanges(),t.addRange(n)}else{const i=o.nodeType===Node.TEXT_NODE?o.parentElement:o,a=window.getComputedStyle(i),r=parseFloat(a.fontSize),s="increase"===e?r+1:r-1;if(s>0){const e=document.createElement("span");e.dataset.fontSized="true",e.style.fontSize=`${s}px`;try{const o=n.extractContents();e.appendChild(o),n.insertNode(e),t.removeAllRanges();const i=document.createRange();i.selectNodeContents(e),t.addRange(i)}catch(e){console.error("Could not apply font size change:",e)}}}}function applyTheme(e){"dark"===e?(document.body.classList.add("dark-mode"),themeToggleButton.textContent="淺色模式"):(document.body.classList.remove("dark-mode"),themeToggleButton.textContent="深色模式")}turndownService.addRule("underline",{filter:"u",replacement:function(e){return"<u>"+e+"</u>"}}),turndownService.addRule("fontSizeSpan",{filter:function(e){return"SPAN"===e.nodeName&&e.style.fontSize},replacement:function(e,t){return'<span style="'+t.getAttribute("style")+'">'+e+"</span>"}}),turndownService.addRule("italic",{filter:["em","i"],replacement:function(e){return"*"+e+"*"}}),themeToggleButton.addEventListener("click",()=>{const e=document.body.classList.toggle("dark-mode")?"dark":"light";localStorage.setItem("theme",e),applyTheme(e)});const savedTheme=localStorage.getItem("theme")||"light";applyTheme(savedTheme);const collapseImmersiveButtons=()=>{document.body.classList.contains("immersive-mode")&&buttonContainer.classList.remove("expanded")},resetInactivityTimer=()=>{clearTimeout(inactivityTimer),document.body.classList.contains("immersive-mode")&&(inactivityTimer=setTimeout(collapseImmersiveButtons,3e3))},activityListeners=["mousemove","keydown","scroll"],addActivityListeners=()=>{activityListeners.forEach(e=>{window.addEventListener(e,resetInactivityTimer)})},removeActivityListeners=()=>{activityListeners.forEach(e=>{window.removeEventListener(e,resetInactivityTimer)})};function updateFontSize(){mainEditor.style.fontSize=`${currentFontSize}rem`,localStorage.setItem("boshiamy-font-size",currentFontSize),updateModeIndicator()}immersiveToggleButton.addEventListener("click",()=>{document.body.classList.toggle("immersive-mode")?(immersiveToggleButton.textContent="離開沉浸模式",addActivityListeners(),resetInactivityTimer()):(immersiveToggleButton.textContent="沉浸模式",buttonContainer.classList.remove("expanded"),clearTimeout(inactivityTimer),removeActivityListeners())}),buttonToggle.addEventListener("click",()=>{buttonContainer.classList.toggle("expanded"),buttonContainer.classList.contains("expanded")?clearTimeout(inactivityTimer):resetInactivityTimer()}),topButtonToggle.addEventListener("click",()=>{topButtonContainer.classList.toggle("expanded")}),document.addEventListener("click",e=>{topButtonContainer.classList.contains("expanded")&&!topButtonContainer.contains(e.target)&&topButtonContainer.classList.remove("expanded")});const zoomIn=()=>{currentFontSize+=.1,updateFontSize()},zoomOut=()=>{currentFontSize>.5&&(currentFontSize-=.1,updateFontSize())},stopZoom=()=>{zoomInterval&&(clearInterval(zoomInterval),zoomInterval=null)};function toggleImeMode(){"disabled"===imeMode?lastActiveImeMode="boshiamy"===lastActiveImeMode?"english":"boshiamy":(imeMode="boshiamy"===imeMode?"english":"boshiamy",lastActiveImeMode=imeMode),"disabled"!==imeMode&&localStorage.setItem("boshiamy-ime-mode",imeMode),clearImeState(),updateModeIndicator()}function toggleDisabledMode(){"disabled"===imeMode?imeMode=lastActiveImeMode:(lastActiveImeMode=imeMode,imeMode="disabled"),localStorage.setItem("boshiamy-ime-mode",imeMode),clearImeState(),updateModeIndicator(),updateLogoState()}function updateLogoState(){"disabled"===imeMode?(logoImage.classList.add("disabled-logo"),logoContainer.title="點擊啟用輸入法"):(logoImage.classList.remove("disabled-logo"),logoContainer.title="點擊暫停輸入法 (無效模式)")}function updateModeIndicator(){let e="",t="";"boshiamy"===imeMode?(e="嘸蝦米模式",t="boshiamy"):"english"===imeMode?(e="英數模式",t="english"):(e="無效模式",t="disabled");const n=Math.round(10*currentFontSize);modeIndicator.innerHTML=`<span class="mode-text ${t}">${e}</span> (Ctrl+p 切換)<span class="font-size-indicator">, 字型大小：${n}</span>`}function handleKeyDown(e){const t=e.key;if(e.ctrlKey||e.metaKey){if(["b","i","u"].includes(t.toLowerCase())){e.preventDefault();return void toggleStyle({b:"bold",i:"italic",u:"underline"}[t.toLowerCase()])}return"p"===t.toLowerCase()?(e.preventDefault(),void toggleImeMode()):"["===t||e.shiftKey&&"<"===t||"9"===t?(e.preventDefault(),void changeSelectionFontSize("decrease")):"]"===t||e.shiftKey&&">"===t||"0"===t?(e.preventDefault(),void changeSelectionFontSize("increase")):void 0}if("boshiamy"===imeMode){if(/^[a-z,.'\[\]vrsf]$/.test(t.toLowerCase())){e.preventDefault(),inputBuffer+=t.toLowerCase();const n=boshiamyData[inputBuffer];candidates=n?n.split(""):[],currentPage=0,updateImeDisplay()}else if(t>="0"&&t<="9"&&candidates.length>0){e.preventDefault();const n=parseInt(t,10),o=10*currentPage+n;o<candidates.length&&commitText(candidates[o])}else if("Backspace"===t){if(inputBuffer.length>0){e.preventDefault(),inputBuffer=inputBuffer.slice(0,-1);const t=boshiamyData[inputBuffer];candidates=t?t.split(""):[],currentPage=0,updateImeDisplay()}}else if(" "===t||"Spacebar"===t){if(0===inputBuffer.length)return;e.preventDefault();const t={v:1,r:2,s:3,f:4},n=inputBuffer.slice(-1);if(inputBuffer.length>1&&t.hasOwnProperty(n)){if(!boshiamyData.hasOwnProperty(inputBuffer)){const e=inputBuffer.slice(0,-1),o=t[n];if(boshiamyData.hasOwnProperty(e)&&boshiamyData[e].length>o){commitText(boshiamyData[e].split("")[o])}else clearImeState();return}}candidates.length>0?commitText(candidates[0]):clearImeState()}else if("PageDown"===t){if(candidates.length>10){const e=Math.ceil(candidates.length/10);currentPage=(currentPage+1)%e,updateImeDisplay()}}else if("PageUp"===t){if(candidates.length>10){const e=Math.ceil(candidates.length/10);currentPage=(currentPage-1+e)%e,updateImeDisplay()}}else"Enter"===t?inputBuffer.length>0&&clearImeState():t.startsWith("Arrow")&&clearImeState()}}function updateImeBarPosition(){const e=window.getSelection();if(!e.rangeCount||!mainEditor.contains(e.anchorNode))return;const t=e.getRangeAt(0),n=mainEditor.getBoundingClientRect();let o;if(t.collapsed){const n=document.createElement("span");n.textContent="​",t.insertNode(n),o=n.getBoundingClientRect();const i=n.parentNode;i&&(i.removeChild(n),i.normalize()),e.removeAllRanges(),e.addRange(t)}else o=t.getBoundingClientRect();if(!o||0===o.width&&0===o.height)return;let i=o.bottom-n.top+5;const a=imeBar.offsetHeight||30,r=o.height||20,s=n.bottom-o.bottom<1.5*r;i+a>mainEditor.clientHeight&&s&&o.top-n.top>a+5&&(i=o.top-n.top-a-5),imeBar.style.top=`${Math.max(0,i)}px`;const d=window.innerWidth/2;imeBar.style.left="auto",imeBar.style.right="auto",o.left<d?imeBar.style.left=o.left-n.left+"px":imeBar.style.right=n.right-o.right+"px",requestAnimationFrame(()=>{const e=imeBar.getBoundingClientRect();e.right>n.right-5&&(imeBar.style.left="auto",imeBar.style.right="5px"),e.left<n.left+5&&(imeBar.style.right="auto",imeBar.style.left="5px")})}function ensureCursorIsVisible(){const e=window.getSelection();if(!e.rangeCount)return;const t=e.getRangeAt(0),n=mainEditor.getBoundingClientRect();let o;if(t.collapsed){const n=document.createElement("span");n.textContent="​",t.insertNode(n),o=n.getBoundingClientRect();const i=n.parentNode;i&&(i.removeChild(n),i.normalize()),e.removeAllRanges(),e.addRange(t)}else o=t.getBoundingClientRect();!o||0===o.width&&0===o.height||(o.top<n.top?mainEditor.scrollTop+=o.top-n.top:o.bottom>n.bottom&&(mainEditor.scrollTop+=o.bottom-n.bottom))}function updateImeDisplay(){if(0!==inputBuffer.length){if(inputBufferSpan.textContent=inputBuffer,candidates.length>0){const e=10*currentPage,t=e+10,n=candidates.slice(e,t);let o="";if(n.forEach((e,t)=>{o+=`${t}. ${e} `}),candidates.length>10){const e=Math.ceil(candidates.length/10);o+=`(${currentPage+1}/${e})`}candidateListSpan.textContent=o.trim(),imeBar.style.display="flex"}else candidates=[],candidateListSpan.textContent="（無對應字）",imeBar.style.display="flex";updateImeBarPosition()}else imeBar.style.display="none"}function commitText(e){const t=window.getSelection();if(!t.rangeCount)return;const n=t.getRangeAt(0);n.deleteContents();const o=document.createTextNode(e);n.insertNode(o),n.setStartAfter(o),n.collapse(!0),t.removeAllRanges(),t.addRange(n),clearImeState(),mainEditor.focus(),ensureCursorIsVisible()}function clearImeState(){inputBuffer="",candidates=[],currentPage=0,imeBar.style.display="none"}function autoRestore(e){const t=localStorage.getItem(getStorageKey(e));t&&(mainEditor.innerHTML=t,editorContents[e]=t)}zoomInButton.addEventListener("mousedown",()=>{zoomIn(),zoomInterval=setInterval(zoomIn,100)}),zoomOutButton.addEventListener("mousedown",()=>{zoomOut(),zoomInterval=setInterval(zoomOut,100)}),zoomInButton.addEventListener("mouseup",stopZoom),zoomInButton.addEventListener("mouseleave",stopZoom),zoomOutButton.addEventListener("mouseup",stopZoom),zoomOutButton.addEventListener("mouseleave",stopZoom),zoomInButton.addEventListener("touchstart",e=>{e.preventDefault(),zoomIn(),zoomInterval=setInterval(zoomIn,100)}),zoomOutButton.addEventListener("touchstart",e=>{e.preventDefault(),zoomOut(),zoomInterval=setInterval(zoomOut,100)}),zoomInButton.addEventListener("touchend",stopZoom),zoomInButton.addEventListener("touchcancel",stopZoom),zoomOutButton.addEventListener("touchend",stopZoom),zoomOutButton.addEventListener("touchcancel",stopZoom),modeIndicator.addEventListener("click",toggleImeMode),logoContainer.addEventListener("click",toggleDisabledMode),mainEditor.addEventListener("keydown",handleKeyDown),editorTabs.addEventListener("click",e=>{const t=e.target.closest(".tab-button");if(!t)return;const n=parseInt(t.dataset.editor,10);if(n===currentEditorId)return;editorContents[currentEditorId]=mainEditor.innerHTML;const o=editorTabs.querySelector(".active");o&&o.classList.remove("active"),t.classList.add("active"),currentEditorId=n,mainEditor.innerHTML=editorContents[currentEditorId]||"",updateRestoreButtonState(),mainEditor.focus()}),mainEditor.focus(),updateModeIndicator(),updateLogoState(),updateFontSize();const urlParams=new URLSearchParams(window.location.search);function getStorageKey(e){return`boshiamy-editor-content-${e}`}function updateRestoreButtonState(){const e=""===mainEditor.innerText.trim(),t=!!localStorage.getItem(getStorageKey(currentEditorId));restoreButton.disabled=!e||!t}"restore"===urlParams.get("action")&&history.replaceState(null,"",window.location.pathname),setTimeout(()=>{updateRestoreButtonState()},0),mainEditor.addEventListener("blur",()=>{clearImeState()}),copyButton.addEventListener("click",()=>{const e=mainEditor.innerText;e&&navigator.clipboard.writeText(e).then(()=>{const e=copyButton.textContent;copyButton.textContent="已複製！",setTimeout(()=>{copyButton.textContent=e},2e3)}).catch(e=>{console.error("無法複製文字: ",e)})}),mainEditor.addEventListener("paste",e=>{e.preventDefault();const t=(e.clipboardData||window.clipboardData).getData("text/plain"),n=window.getSelection();if(!n.rangeCount)return;const o=n.getRangeAt(0);o.deleteContents();const i=document.createTextNode(t);o.insertNode(i),o.setStartAfter(i),o.collapse(!0),n.removeAllRanges(),n.addRange(o),requestAnimationFrame(()=>{const e=window.getSelection();if(!e.rangeCount)return;const t=e.getRangeAt(0),n=document.createElement("span");t.insertNode(n);const o=n.getBoundingClientRect();n.parentNode.removeChild(n);const i=mainEditor.getBoundingClientRect(),a=window.getComputedStyle(mainEditor),r=parseFloat(a.paddingBottom),s=i.bottom-r;o.bottom>s&&(mainEditor.scrollTop+=o.bottom-s)})}),saveMdButton.addEventListener("click",()=>{const e=mainEditor.innerHTML;if(e){const t=turndownService.turndown(e),n=new Blob([t],{type:"text/markdown;charset=utf-t"}),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download="document.md",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(o.href)}});const autoSaveChanges=()=>{const e=mainEditor.innerHTML;editorContents[currentEditorId]=e,localStorage.setItem(getStorageKey(currentEditorId),e),updateRestoreButtonState()},debouncedSave=debounce(autoSaveChanges,500);mainEditor.addEventListener("keyup",()=>{updateRestoreButtonState(),debouncedSave(),attachPersistentSaveListeners(),ensureCursorIsVisible()}),restoreButton.addEventListener("click",()=>{const e=localStorage.getItem(getStorageKey(currentEditorId));if(e){mainEditor.innerHTML=e,updateRestoreButtonState();const t=restoreButton.textContent;restoreButton.textContent="已讀回！",setTimeout(()=>{restoreButton.textContent=t},2e3)}}),document.addEventListener("selectionchange",()=>{"none"!==imeBar.style.display&&requestAnimationFrame(updateImeBarPosition)});