const mainEditor=document.getElementById("main-editor"),imeBar=document.getElementById("ime-bar"),inputBufferSpan=document.getElementById("input-buffer"),candidateListSpan=document.getElementById("candidate-list"),modeIndicator=document.getElementById("mode-indicator"),copyButton=document.getElementById("copy-button"),themeToggleButton=document.getElementById("theme-toggle-button"),immersiveToggleButton=document.getElementById("immersive-toggle-button"),zoomInButton=document.getElementById("zoom-in-button"),zoomOutButton=document.getElementById("zoom-out-button"),saveMdButton=document.getElementById("save-md-button"),restoreButton=document.getElementById("restore-button"),buttonContainer=document.querySelector(".button-container"),buttonToggle=document.getElementById("button-toggle"),editorTabs=document.getElementById("editor-tabs"),topButtonContainer=document.getElementById("top-button-container"),topButtonToggle=document.getElementById("top-button-toggle");let currentEditorId=1,editorContents={1:"",2:"",3:""},inputBuffer="",candidates=[],currentPage=0;const pageSize=10;let inactivityTimer,imeMode=localStorage.getItem("boshiamy-ime-mode")||"boshiamy",currentFontSize=parseFloat(localStorage.getItem("boshiamy-font-size"))||1.2,zoomInterval=null,persistentSaveListenersAttached=!1;function attachPersistentSaveListeners(){persistentSaveListenersAttached||(document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&autoSaveChanges()}),persistentSaveListenersAttached=!0)}function debounce(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout(()=>e.apply(this,o),t)}}const turndownService=new TurndownService({headingStyle:"atx"});function toggleStyle(e){const t=window.getSelection();if(!t.rangeCount)return;const n=t.getRangeAt(0);if(!n.toString())return;const o=1===n.commonAncestorContainer.nodeType?n.commonAncestorContainer:n.commonAncestorContainer.parentElement,a={bold:"STRONG",italic:"EM",underline:"U"}[e],i=o.closest(a);if(i){const e=document.createTextNode(i.textContent);i.parentNode.replaceChild(e,i),n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}else{const e=document.createElement(a);try{n.surroundContents(e)}catch(t){console.warn("surroundContents failed, falling back.",t);const o=n.extractContents();e.appendChild(o),n.insertNode(e)}t.removeAllRanges();const o=document.createRange();o.selectNodeContents(e),t.addRange(o)}}function changeSelectionFontSize(e){const t=window.getSelection();if(!t.rangeCount||t.isCollapsed)return;const n=t.getRangeAt(0),o=n.commonAncestorContainer,a=(o.nodeType===Node.ELEMENT_NODE?o:o.parentElement).closest('span[data-font-sized="true"]');if(a){const o=parseFloat(window.getComputedStyle(a).fontSize),i="increase"===e?o+1:o-1;i>0&&(a.style.fontSize=`${i}px`),t.removeAllRanges(),t.addRange(n)}else{const a=o.nodeType===Node.TEXT_NODE?o.parentElement:o,i=window.getComputedStyle(a),r=parseFloat(i.fontSize),s="increase"===e?r+1:r-1;if(s>0){const e=document.createElement("span");e.dataset.fontSized="true",e.style.fontSize=`${s}px`;try{const o=n.extractContents();e.appendChild(o),n.insertNode(e),t.removeAllRanges();const a=document.createRange();a.selectNodeContents(e),t.addRange(a)}catch(e){console.error("Could not apply font size change:",e)}}}}function applyTheme(e){"dark"===e?(document.body.classList.add("dark-mode"),themeToggleButton.textContent="淺色模式"):(document.body.classList.remove("dark-mode"),themeToggleButton.textContent="深色模式")}turndownService.addRule("underline",{filter:"u",replacement:function(e){return"<u>"+e+"</u>"}}),turndownService.addRule("fontSizeSpan",{filter:function(e){return"SPAN"===e.nodeName&&e.style.fontSize},replacement:function(e,t){return'<span style="'+t.getAttribute("style")+'">'+e+"</span>"}}),turndownService.addRule("italic",{filter:["em","i"],replacement:function(e){return"*"+e+"*"}}),themeToggleButton.addEventListener("click",()=>{const e=document.body.classList.toggle("dark-mode")?"dark":"light";localStorage.setItem("theme",e),applyTheme(e)});const savedTheme=localStorage.getItem("theme")||"light";applyTheme(savedTheme);const collapseImmersiveButtons=()=>{document.body.classList.contains("immersive-mode")&&buttonContainer.classList.remove("expanded")},resetInactivityTimer=()=>{clearTimeout(inactivityTimer),document.body.classList.contains("immersive-mode")&&(inactivityTimer=setTimeout(collapseImmersiveButtons,3e3))},activityListeners=["mousemove","keydown","scroll"],addActivityListeners=()=>{activityListeners.forEach(e=>{window.addEventListener(e,resetInactivityTimer)})},removeActivityListeners=()=>{activityListeners.forEach(e=>{window.removeEventListener(e,resetInactivityTimer)})};function updateFontSize(){mainEditor.style.fontSize=`${currentFontSize}rem`,localStorage.setItem("boshiamy-font-size",currentFontSize),updateModeIndicator()}immersiveToggleButton.addEventListener("click",()=>{document.body.classList.toggle("immersive-mode")?(immersiveToggleButton.textContent="離開沉浸模式",addActivityListeners(),resetInactivityTimer()):(immersiveToggleButton.textContent="沉浸模式",buttonContainer.classList.remove("expanded"),clearTimeout(inactivityTimer),removeActivityListeners())}),buttonToggle.addEventListener("click",()=>{buttonContainer.classList.toggle("expanded"),buttonContainer.classList.contains("expanded")?clearTimeout(inactivityTimer):resetInactivityTimer()}),topButtonToggle.addEventListener("click",()=>{topButtonContainer.classList.toggle("expanded")}),document.addEventListener("click",e=>{topButtonContainer.classList.contains("expanded")&&!topButtonContainer.contains(e.target)&&topButtonContainer.classList.remove("expanded")});const zoomIn=()=>{currentFontSize+=.1,updateFontSize()},zoomOut=()=>{currentFontSize>.5&&(currentFontSize-=.1,updateFontSize())},stopZoom=()=>{zoomInterval&&(clearInterval(zoomInterval),zoomInterval=null)};function toggleImeMode(){imeMode="boshiamy"===imeMode?"english":"boshiamy",localStorage.setItem("boshiamy-ime-mode",imeMode),clearImeState(),updateModeIndicator()}function updateModeIndicator(){const e="boshiamy"===imeMode?"嘸蝦米模式":"英數模式",t="boshiamy"===imeMode?"boshiamy":"english",n=Math.round(10*currentFontSize);modeIndicator.innerHTML=`<span class="mode-text ${t}">${e}</span> (Ctrl+p 切換)<span class="font-size-indicator">, 字型大小：${n}</span>`}function handleKeyDown(e){const t=e.key;if(e.ctrlKey||e.metaKey){if(["b","i","u"].includes(t.toLowerCase())){e.preventDefault();return void toggleStyle({b:"bold",i:"italic",u:"underline"}[t.toLowerCase()])}return"p"===t.toLowerCase()?(e.preventDefault(),void toggleImeMode()):"["===t||e.shiftKey&&"<"===t||"9"===t?(e.preventDefault(),void changeSelectionFontSize("decrease")):"]"===t||e.shiftKey&&">"===t||"0"===t?(e.preventDefault(),void changeSelectionFontSize("increase")):void 0}if("boshiamy"===imeMode){if(/^[a-z,.'\[\]vrsf]$/.test(t.toLowerCase())){e.preventDefault(),inputBuffer+=t.toLowerCase();const n=boshiamyData[inputBuffer];candidates=n?n.split(""):[],currentPage=0,updateImeDisplay()}else if(t>="0"&&t<="9"&&candidates.length>0){e.preventDefault();const n=parseInt(t,10),o=10*currentPage+n;o<candidates.length&&commitText(candidates[o])}else if("Backspace"===t){if(inputBuffer.length>0){e.preventDefault(),inputBuffer=inputBuffer.slice(0,-1);const t=boshiamyData[inputBuffer];candidates=t?t.split(""):[],currentPage=0,updateImeDisplay()}}else if(" "===t||"Spacebar"===t){if(0===inputBuffer.length)return;e.preventDefault();const t={v:1,r:2,s:3,f:4},n=inputBuffer.slice(-1);if(inputBuffer.length>1&&t.hasOwnProperty(n)){if(!boshiamyData.hasOwnProperty(inputBuffer)){const e=inputBuffer.slice(0,-1),o=t[n];if(boshiamyData.hasOwnProperty(e)&&boshiamyData[e].length>o){commitText(boshiamyData[e].split("")[o])}else clearImeState();return}}if(candidates.length>0){const e=Math.ceil(candidates.length/10);e>1?(currentPage=(currentPage+1)%e,updateImeDisplay()):commitText(candidates[0])}else clearImeState()}else"Enter"===t?inputBuffer.length>0&&clearImeState():t.startsWith("Arrow")&&clearImeState()}}function updateImeDisplay(){if(0!==inputBuffer.length)if(inputBufferSpan.textContent=inputBuffer,candidates.length>0){const e=10*currentPage,t=e+10,n=candidates.slice(e,t);let o="";if(n.forEach((e,t)=>{o+=`${t}. ${e} `}),candidates.length>10){const e=Math.ceil(candidates.length/10);o+=`(${currentPage+1}/${e})`}candidateListSpan.textContent=o.trim(),imeBar.style.display="flex"}else candidates=[],candidateListSpan.textContent="（無對應字）",imeBar.style.display="flex";else imeBar.style.display="none"}function commitText(e){const t=window.getSelection();if(!t.rangeCount)return;const n=t.getRangeAt(0);n.deleteContents();const o=document.createTextNode(e);n.insertNode(o),n.setStartAfter(o),n.collapse(!0),t.removeAllRanges(),t.addRange(n),clearImeState(),mainEditor.focus()}function clearImeState(){inputBuffer="",candidates=[],currentPage=0,imeBar.style.display="none"}function autoRestore(e){const t=localStorage.getItem(getStorageKey(e));t&&(mainEditor.innerHTML=t,editorContents[e]=t)}zoomInButton.addEventListener("mousedown",()=>{zoomIn(),zoomInterval=setInterval(zoomIn,100)}),zoomOutButton.addEventListener("mousedown",()=>{zoomOut(),zoomInterval=setInterval(zoomOut,100)}),zoomInButton.addEventListener("mouseup",stopZoom),zoomInButton.addEventListener("mouseleave",stopZoom),zoomOutButton.addEventListener("mouseup",stopZoom),zoomOutButton.addEventListener("mouseleave",stopZoom),zoomInButton.addEventListener("touchstart",e=>{e.preventDefault(),zoomIn(),zoomInterval=setInterval(zoomIn,100)}),zoomOutButton.addEventListener("touchstart",e=>{e.preventDefault(),zoomOut(),zoomInterval=setInterval(zoomOut,100)}),zoomInButton.addEventListener("touchend",stopZoom),zoomInButton.addEventListener("touchcancel",stopZoom),zoomOutButton.addEventListener("touchend",stopZoom),zoomOutButton.addEventListener("touchcancel",stopZoom),modeIndicator.addEventListener("click",toggleImeMode),mainEditor.addEventListener("keydown",handleKeyDown),editorTabs.addEventListener("click",e=>{const t=e.target.closest(".tab-button");if(!t)return;const n=parseInt(t.dataset.editor,10);if(n===currentEditorId)return;editorContents[currentEditorId]=mainEditor.innerHTML;const o=editorTabs.querySelector(".active");o&&o.classList.remove("active"),t.classList.add("active"),currentEditorId=n,mainEditor.innerHTML=editorContents[currentEditorId]||"",updateRestoreButtonState(),mainEditor.focus()}),mainEditor.focus(),updateModeIndicator(),updateFontSize();const urlParams=new URLSearchParams(window.location.search);function getStorageKey(e){return`boshiamy-editor-content-${e}`}function updateRestoreButtonState(){const e=""===mainEditor.innerText.trim(),t=!!localStorage.getItem(getStorageKey(currentEditorId));restoreButton.disabled=!e||!t}"restore"===urlParams.get("action")&&history.replaceState(null,"",window.location.pathname),setTimeout(()=>{updateRestoreButtonState()},0),mainEditor.addEventListener("blur",()=>{clearImeState()}),copyButton.addEventListener("click",()=>{const e=mainEditor.innerText;e&&navigator.clipboard.writeText(e).then(()=>{const e=copyButton.textContent;copyButton.textContent="已複製！",setTimeout(()=>{copyButton.textContent=e},2e3)}).catch(e=>{console.error("無法複製文字: ",e)})}),mainEditor.addEventListener("paste",e=>{e.preventDefault();const t=(e.clipboardData||window.clipboardData).getData("text/plain"),n=window.getSelection();if(!n.rangeCount)return;const o=n.getRangeAt(0);o.deleteContents();const a=document.createTextNode(t);o.insertNode(a),o.setStartAfter(a),o.collapse(!0),n.removeAllRanges(),n.addRange(o),requestAnimationFrame(()=>{const e=window.getSelection();if(!e.rangeCount)return;const t=e.getRangeAt(0),n=document.createElement("span");t.insertNode(n);const o=n.getBoundingClientRect();n.parentNode.removeChild(n);const a=mainEditor.getBoundingClientRect(),i=window.getComputedStyle(mainEditor),r=parseFloat(i.paddingBottom),s=a.bottom-r;o.bottom>s&&(mainEditor.scrollTop+=o.bottom-s)})}),saveMdButton.addEventListener("click",()=>{const e=mainEditor.innerHTML;if(e){const t=turndownService.turndown(e),n=new Blob([t],{type:"text/markdown;charset=utf-t"}),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download="document.md",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(o.href)}});const autoSaveChanges=()=>{const e=mainEditor.innerHTML;editorContents[currentEditorId]=e,localStorage.setItem(getStorageKey(currentEditorId),e),updateRestoreButtonState()},debouncedSave=debounce(autoSaveChanges,500);mainEditor.addEventListener("keyup",()=>{updateRestoreButtonState(),debouncedSave(),attachPersistentSaveListeners()}),restoreButton.addEventListener("click",()=>{const e=localStorage.getItem(getStorageKey(currentEditorId));if(e){mainEditor.innerHTML=e,updateRestoreButtonState();const t=restoreButton.textContent;restoreButton.textContent="已讀回！",setTimeout(()=>{restoreButton.textContent=t},2e3)}});